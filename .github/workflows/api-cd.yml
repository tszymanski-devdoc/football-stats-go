name: Football stats go API CD Pipeline

on:
  workflow_run:
    workflows: ["Football stats go API CI Pipeline"]
    types:
      - completed
    branches:
      - main

jobs:
  migrate:
    name: Run Database Migrations
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache-dependency-path: football-stats-go-api/go.sum

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Install Cloud SQL Proxy
        run: |
          curl -o cloud-sql-proxy https://storage.googleapis.com/cloud-sql-connectors/cloud-sql-proxy/v2.15.0/cloud-sql-proxy.linux.amd64
          chmod +x cloud-sql-proxy

      - name: Run Cloud SQL Proxy for football-stats-go-db
        run: |
          ./cloud-sql-proxy ${{ secrets.GCP_PROJECT_ID }}:${{ secrets.GCP_REGION }}:football-stats-go-db --port 5432 &
          sleep 5

      - name: Run Database Migrations
        working-directory: football-stats-go-api
        run: |
          go run cmd/migrate/main.go -direction up
        env:
          DATABASE_URL: postgresql://${{ secrets.DB_USER }}:${{ secrets.DB_PASSWORD }}@127.0.0.1:5432/postgres?sslmode=disable

  deploy:
    name: Deploy to Cloud Run
    needs: migrate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy to Cloud Run
        id: deploy
        run: |
          gcloud run deploy football-stats-go-api \
            --image gcr.io/${{ secrets.GCP_PROJECT_ID }}/football-stats-go-api:latest \
            --region ${{ secrets.GCP_REGION || 'us-central1' }} \
            --platform managed \
            --allow-unauthenticated \
            --memory 512Mi \
            --cpu 1 \
            --max-instances 10 \
            --min-instances 0 \
            --timeout 300 \
            --port 8080 \
            --add-cloudsql-instances ${{ secrets.GCP_PROJECT_ID }}:${{ secrets.GCP_REGION }}:football-stats-go-db \
            --set-env-vars "APP_ENV=production,APP_NAME=football-stats-api,DATABASE_URL=postgresql://${{ secrets.DB_USER }}:${{ secrets.DB_PASSWORD }}@/postgres?host=/cloudsql/${{ secrets.GCP_PROJECT_ID }}:${{ secrets.GCP_REGION }}:football-stats-go-db&sslmode=disable" \
            --quiet

      - name: Get Service URL
        run: |
          SERVICE_URL=$(gcloud run services describe football-stats-go-api \
            --region ${{ secrets.GCP_REGION || 'us-central1' }} \
            --format 'value(status.url)')
          echo "Service deployed to: $SERVICE_URL"
          echo "SERVICE_URL=$SERVICE_URL" >> $GITHUB_ENV

      - name: Wait for service to be ready
        run: sleep 15

      - name: Test deployment
        run: |
          echo "Testing health endpoint..."
          for i in {1..5}; do
            if curl -f -s ${{ env.SERVICE_URL }}/health > /dev/null; then
              echo "âœ… Deployment successful!"
              exit 0
            fi
            echo "Attempt $i failed, retrying in 5 seconds..."
            sleep 5
          done
          echo "âŒ Health check failed after 5 attempts"
          exit 1

      - name: Create deployment summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Service**: football-stats-go-api" >> $GITHUB_STEP_SUMMARY
          echo "- **Region**: ${{ secrets.GCP_REGION || 'us-central1' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: ${{ env.SERVICE_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: gcr.io/${{ secrets.GCP_PROJECT_ID }}/football-stats-go-api:latest" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Endpoints" >> $GITHUB_STEP_SUMMARY
          echo "- Health: [${{ env.SERVICE_URL }}/health](${{ env.SERVICE_URL }}/health)" >> $GITHUB_STEP_SUMMARY
          echo "- API Root: [${{ env.SERVICE_URL }}/api/v1](${{ env.SERVICE_URL }}/api/v1)" >> $GITHUB_STEP_SUMMARY